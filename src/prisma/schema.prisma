// ARQUIVO: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
// ENUMS (Regras de Negócio)
// =========================================================

enum UserStatus {
  PENDING           // Cadastro incompleto
  ACTIVE            // Aprovado e Operacional
  BLOCKED           // Bloqueio temporário
  BANNED            // Banimento definitivo
  UNDER_REVIEW      // Em auditoria
}

enum ActiveRole {
  STUDENT           // Modo Aluno
  PROFESSIONAL      // Modo Carreira
  BUSINESS          // Modo Negócio
  FRANCHISEE        // Modo Franqueado
  ADMIN             // Modo Super Admin
}

enum ProfessionalType {
  PERSONAL_TRAINER
  NUTRITIONIST
  PHYSIOTHERAPIST
  YOGA_INSTRUCTOR
  CROSSFIT_COACH
  FIGHT_INSTRUCTOR
  DANCE_INSTRUCTOR
  PSYCHOLOGIST
  OTHER
}

enum SpaceType {
  GYM               // Academia
  STUDIO            // Estúdio
  BOX               // Crossfit
  COURT             // Quadra
  POOL              // Piscina
  CLUB              // Clube
  OUTDOOR_HUB       // Ponto de encontro ao ar livre
}

enum BookingStatus {
  PENDING_PAYMENT   // Aguardando pgto
  SCHEDULED         // Pago, aguardando 15min ou aceite
  CONFIRMED         // Confirmado
  CHECKED_IN        // Em andamento
  COMPLETED         // Finalizado
  CANCELLED_USER    // Aluno cancelou
  CANCELLED_PROVIDER// Profissional/Espaço cancelou
  DISPUTED          // Em disputa
  NO_SHOW           // Aluno faltou
}

enum TransactionType {
  DEPOSIT           // Entrada
  PAYMENT_HELD      // Bloqueado para aula
  RELEASE_SPLIT     // Liberado para prestador
  PENALTY           // Multa
  REFUND            // Estorno
  WITHDRAWAL        // Saque
  FRANCHISE_COMMISSION // Taxa Franquia
  REFERRAL_BONUS    // Indicação
}

enum FranchiseTier {
  TIER_1_SMALL      // < 50k hab
  TIER_2_MEDIUM     // 50k - 200k
  TIER_3_LARGE      // 200k - 500k
  TIER_4_METROPOLIS // > 500k
}

// =========================================================
// NÚCLEO DE IDENTIDADE
// =========================================================

model User {
  id            String      @id @default(uuid())
  
  // E-MAIL AGORA É OPCIONAL (?)
  email         String?     @unique
  
  // TELEFONE AGORA É OBRIGATÓRIO (sem ?)
  phone         String      @unique
  
  // Demais campos continuam iguais...
  cpf           String?     @unique
  password      String
  name          String
  avatarUrl     String?
  
  status        UserStatus  @default(PENDING)
  currentRole   ActiveRole  @default(STUDENT)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relações...
  studentProfile      StudentProfile?
  professionalProfile ProfessionalProfile?
  spaceProfiles       SpaceProfile[]      
  franchiseeProfile   FranchiseeProfile?
  adminProfile        AdminProfile?
  wallet              Wallet?
  addresses           Address[]           
  notifications       Notification[]
}

model Address {
  id          String   @id @default(uuid())
  label       String   
  street      String
  number      String
  complement  String?
  district    String   
  city        String
  state       String   
  zipCode     String   
  
  latitude    Float?
  longitude   Float?

  active      Boolean  @default(true)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  spaceProfileId String?
  spaceProfile   SpaceProfile? @relation(fields: [spaceProfileId], references: [id])
}

// =========================================================
// PERFIS
// =========================================================

model StudentProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  referralCode  String   @unique
  referredById  String?  
  
  xp            Int      @default(0)
  level         Int      @default(1)

  bookings      Booking[] 
}

model ProfessionalProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          ProfessionalType
  documentType  String   // CREF, CRN
  documentNumber String  
  documentPhotoUrl String? 
  selfieVerificationUrl String? 

  bio           String?  @db.Text
  specialties   String?  
  
  radiusKm      Int      @default(10)
  rating        Decimal  @default(5.0) @db.Decimal(3, 2)
  ratingCount   Int      @default(0)

  attendsHome    Boolean @default(false)
  attendsOnline  Boolean @default(false)
  attendsOutdoor Boolean @default(false)
  attendsGym     Boolean @default(true)

  services      Service[]
  bookings      Booking[] 
}

model SpaceProfile {
  id            String   @id @default(uuid())
  userId        String   
  user          User     @relation(fields: [userId], references: [id])

  name          String   
  corporateName String?  
  cnpj          String?
  
  type          SpaceType
  description   String?  @db.Text
  photos        String?  @db.Text 
  resources     String?  @db.Text 
  capacity      Int      @default(100)

  rating        Decimal  @default(5.0) @db.Decimal(3, 2)
  ratingCount   Int      @default(0)
  
  addresses     Address[]
  services      Service[]
  classes       Class[]
  bookings      Booking[] 
}

model FranchiseeProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  cnpj          String?
  contractUrl   String?  
  
  territories   FranchiseTerritory[]
}

model AdminProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  level         Int      @default(1) 
}

// =========================================================
// GEOGRAFIA & FRANQUIAS
// =========================================================

model FranchiseTerritory {
  id            String        @id @default(uuid())
  city          String
  state         String
  ibgeCode      String?       @unique 
  tier          FranchiseTier @default(TIER_1_SMALL)
  
  active        Boolean       @default(true)
  
  franchiseeId  String?
  franchisee    FranchiseeProfile? @relation(fields: [franchiseeId], references: [id])

  createdAt     DateTime      @default(now())
}

// =========================================================
// PRODUTOS
// =========================================================

model Service {
  id          String    @id @default(uuid())
  name        String    
  description String?
  price       Decimal   @db.Decimal(10, 2)
  durationMin Int       
  
  active      Boolean   @default(true)

  professionalProfileId String?
  professionalProfile   ProfessionalProfile? @relation(fields: [professionalProfileId], references: [id])
   
  spaceProfileId        String?
  spaceProfile          SpaceProfile?        @relation(fields: [spaceProfileId], references: [id])
  
  bookings    Booking[]
}

model Class {
  id          String    @id @default(uuid())
  name        String    
  description String?
  
  spaceProfileId String
  spaceProfile   SpaceProfile @relation(fields: [spaceProfileId], references: [id])
  
  date        DateTime? 
  capacity    Int       @default(20)
  price       Decimal   @db.Decimal(10, 2)
  
  bookings    Booking[]
}

// =========================================================
// FINANCEIRO & AGENDAMENTO
// =========================================================

model Wallet {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])

  balanceAvailable Decimal @default(0.00) @db.Decimal(10, 2) 
  balanceHeld      Decimal @default(0.00) @db.Decimal(10, 2) 
  balanceDispute   Decimal @default(0.00) @db.Decimal(10, 2) 

  transactions    Transaction[]
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id          String          @id @default(uuid())
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  description String?
  
  walletId    String
  wallet      Wallet          @relation(fields: [walletId], references: [id])
  
  bookingId   String?         
  booking     Booking?        @relation(fields: [bookingId], references: [id])

  createdAt   DateTime        @default(now())
}

model Booking {
  id            String        @id @default(uuid())
  status        BookingStatus @default(PENDING_PAYMENT)
  
  studentId     String
  student       StudentProfile @relation(fields: [studentId], references: [id])

  serviceId     String?
  service       Service?       @relation(fields: [serviceId], references: [id])
  
  classId       String?
  classItem     Class?         @relation(fields: [classId], references: [id]) 

  professionalId String?
  professional   ProfessionalProfile? @relation(fields: [professionalId], references: [id])

  spaceId       String?
  space         SpaceProfile?       @relation(fields: [spaceId], references: [id])

  scheduledAt   DateTime      
  checkInAt     DateTime?     
  completedAt   DateTime?     

  priceTotal    Decimal       @db.Decimal(10, 2) 
  
  splitAppAmount        Decimal @default(0.00) @db.Decimal(10, 2)
  splitFranchiseeAmount Decimal @default(0.00) @db.Decimal(10, 2)
  splitProviderAmount   Decimal @default(0.00) @db.Decimal(10, 2) 
  splitSpaceAmount      Decimal @default(0.00) @db.Decimal(10, 2) 

  cancellationReason String?
  cancelledBy        String?  

  transactions  Transaction[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}